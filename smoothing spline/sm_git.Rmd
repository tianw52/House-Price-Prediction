---
title: "House Price Prediction -- Smoothing Model"
author: "Tian"
output: 
    pdf_document
---

# Summary

## Preprocessing

### Transformation (if any, delete if none)
* price: performed box-cox transformation on the response variate price.
* saledate: transformed as the number of days since 1970/01/01, then take the power of 5
* landarea: take log
* stories: take log
* rmdl_diff: log(rmdl_diff + 1) because some of them are zero
* all categorical variables is treated as factors


### New Variables (if any, delete if none)
<!-- List all variables/predictors added to dtrain and dtest  -->
* if_rmdl : indicator whether the house is remodeled
* rmdl_diff: numerical rep the difference between remodel date and sale date;
0 if remodel is after sale
* saleyear: year of the sale
* buy_first: indicator whether the house is build first or buy first
* total_bath: combine number of bathroom and number of half-bathrooms (bathrm+0.5hf_bathrm)

### Missing data handling
<!-- There are missing values in some variables, need to do something -->
* yr_rmdl: missing yr_rmdl is recoded as 0 (we use if_rmdl and rmdl_diff instead of yr_rmdl in the model)
* ayb: missing ayb is recoded as eyb - avg_gap between ayb and eyb
* quadrant: missing quadrant is recoded as "NW" bc "NW" is most popular
* kitchen and stories: omitted

## Model Building

Main package used: `mgcv::gam`

* fitted all predictors naively
* deleted insignificant ones and adjust number of knots for `ayb`
* forward selection to examine significance of interaction
* added interaction (`ti`) between continous predictors
* added interaction (`by` in `s()`) between continous and categorical

## Final Model
<!-- formula in your final fitted function  -->
* The final model is $\frac{(price^\lambda-1)}{\lambda} \sim$ s(rooms) +s(total_bath)+s(rmdl_diff)
             +s(bedrm)+s(ayb, k = 20, by = cndtn)+s(eyb)+s(saledate)+s(gba) +fireplaces+s(stories)
             +s(landarea)+s(latitude)+s(longitude)
             +heat+ac+style+grade+cndtn+roof+intwall+kitchens+nbhd+ward
             +quadrant+if_rmdl+buy_first
             + ti(eyb, ayb) + ti(gba,landarea)+ti(longitude,gba)
             + ti(longitude, ayb)
             +ti(longitude, eyb)+ti(saledate,latitude)
             

# 1.Preprocessing

## 1.1 Loading data
```{r,echo=TRUE}
load("smooth.Rdata")
```

examine categorical predictors

```{r}
table(dtrain$heat)
```
```{r}
table(dtrain$ac)
```

```{r}
table(dtrain$style)
```


```{r}
table(dtrain$grade)
```



```{r}
table(dtrain$cndtn)
```


```{r}
table(dtrain$extwall)
```



```{r}
table(dtrain$roof)
```

```{r}
table(dtrain$intwall)
```


```{r}
table(dtrain$ward)
```


```{r}
table(dtrain$quadrant)
```





## 1.2 Missing data handling

Check missing values for each predictor:
```{r,echo=TRUE}
colSums(is.na(dtrain))
```

```{r,echo=TRUE}
colSums(is.na(dtest))
```

So far we don't deal with missing values in `yr_rmdl`, we will add two new variables later to explain it so `yr_rmdl` won't be used directly in the model.

```{r}
# =========== train ===============
avg_gap_train <- mean(dtrain$eyb-dtrain$ayb, na.rm = T)
# missing ayb is recoded as eyb - avg_gap between ayb and eyb
dtrain$ayb <- ifelse(is.na(dtrain$ayb), dtrain$eyb-avg_gap_train, dtrain$ayb)
# missing quadrant is recoded as "NW" bc "NW" is most popular
dtrain$quadrant <- ifelse(is.na(dtrain$quadrant), "NW", dtrain$quadrant)


#=========== test ============
avg_gap_test <- mean(dtest$eyb-dtest$ayb, na.rm = T)
# missing ayb is recoded as eyb - avg_gap between ayb and eyb
dtest$ayb <- ifelse(is.na(dtest$ayb), dtest$eyb-avg_gap_test, dtest$ayb)
# missing quadrant is recoded as "NW" bc "NW" is most popular
dtest$quadrant <- ifelse(is.na(dtest$quadrant), "NW", dtest$quadrant)
```


```{r}
colSums(is.na(dtrain))
```


```{r, eval=F, echo=FALSE}
dtrain[!complete.cases(dtrain), ]
```

```{r, eval=F, echo=FALSE}
dtest[!complete.cases(dtest), ]
```


## 1.3 new variable
```{r}
# binary variable check whether the house is remodeled
dtrain$if_rmdl <- ifelse(is.na(dtrain$yr_rmdl), 0, 1)
dtrain$if_rmdl <- as.factor(dtrain$if_rmdl)

# year of the house sold
dtrain$saleyear<-as.numeric(substr(dtrain$saledate, 1, 4))

# the difference between sale year and the remodel year, if remodel is after sale
# then 0
for (i in seq(nrow(dtrain))) {
  if (is.na(dtrain$yr_rmdl[i])) {
    dtrain$rmdl_diff[i] <- 0
  } else if (dtrain$saleyear[i] <= dtrain$yr_rmdl[i]) {
    dtrain$rmdl_diff[i] <- 0
  } else if (dtrain$saleyear[i] > dtrain$yr_rmdl[i])
    dtrain$rmdl_diff[i] <- dtrain$saleyear[i] - dtrain$yr_rmdl[i]
}


# combine bathroom and half_bathroom
dtrain$total_bath <- dtrain$bathrm+0.5*dtrain$hf_bathrm

# whether it's sold first or build first
dtrain$buy_first <- as.factor(as.numeric(dtrain$saleyear < dtrain$ayb))
```



```{r}
# fill the na for yr_rmdl as 0
dtrain$yr_rmdl <- ifelse(is.na(dtrain$yr_rmdl), 0, dtrain$yr_rmdl)
# omit other na
dtrain_full <- na.omit(dtrain)
```


Now, `dtrain_full` is the complete data frame we will be working with.

## 1.4 data transformation
```{r}
# the number of days since 1970/01/01
dtrain_full$saledate <- as.numeric(as.Date(dtrain_full$saledate))

# to factor
dtrain_full$heat <- as.factor(dtrain_full$heat)
dtrain_full$ac <- as.factor(dtrain_full$ac)
dtrain_full$style <- as.factor(dtrain_full$style)
dtrain_full$grade <- as.factor(dtrain_full$grade)
dtrain_full$cndtn <- as.factor(dtrain_full$cndtn)
dtrain_full$extwall <- as.factor(dtrain_full$extwall)
dtrain_full$roof <- as.factor(dtrain_full$roof)
dtrain_full$intwall <- as.factor(dtrain_full$intwall)
dtrain_full$ward <- as.factor(dtrain_full$ward)
dtrain_full$quadrant <- as.factor(dtrain_full$quadrant)
```

```{r}
dtrain_full$gba <- log(dtrain_full$gba)
dtrain_full$landarea <- log(dtrain_full$landarea)
dtrain_full$saledate <- dtrain_full$saledate^5

dtrain_full$stories <- log(dtrain_full$stories)
dtrain_full$rmdl_diff <- log(dtrain_full$rmdl_diff + 1)
```






# 2. Model building

Note: all the output for model summary is hided because too large.


Perform box-cox transformation to transform `price`

```{r}
naive_lm <- lm(price ~ bathrm + rooms+bedrm+ayb+yr_rmdl+eyb+saledate+gba+landarea+
                 latitude+longitude, data = dtrain_full)

library(MASS)
boxcox_tr <- boxcox(naive_lm)
lambda <- boxcox_tr$x[which.max(boxcox_tr$y)]
```




## 2.1 The naive model
```{r,echo=TRUE, results='hide'}
library(mgcv)
naive_md <- gam(((price^lambda-1)/lambda) ~ s(rooms) + s(bathrm)
                +s(total_bath)+s(rmdl_diff)
                +s(bedrm)+s(ayb)+s(eyb)+s(saledate)+s(gba)
                +fireplaces+s(stories)
                +s(landarea)+s(latitude)+s(longitude)
                + heat+ac+style+grade+cndtn+extwall+roof+intwall+kitchens+nbhd+ward
                +quadrant+if_rmdl+buy_first
                ,data = dtrain_full)

summary(naive_md)
```

```{r}
par(mfrow= c(2,2))
gam.check(naive_md)
```




```{r, results='hide'}
m2 <- gam(((price^lambda-1)/lambda) ~ s(rooms)
                +s(total_bath)+s(rmdl_diff)
                +s(bedrm)+s(ayb, k = 20)+s(eyb)+s(saledate)+s(gba)
                +fireplaces
                +s(landarea)+s(latitude)+s(longitude)
                + heat+ac+style+grade+cndtn+extwall+roof+intwall+kitchens+nbhd+ward
                +if_rmdl+buy_first
                ,data = dtrain_full)

# Summary of the model
summary(m2)
```

```{r}
par(mfrow= c(2,2))
gam.check(m2)
```



```{r}
AIC(naive_md,m2)
```


## 2.2 interaction

Forward selection to find meaningfull interaction terms (output ignored because too large)

```{r, echo=T, message=F, warning=F, results='hide'}
included <- c(
  "bathrm",  "ac", "rooms", "bedrm", "ayb", "eyb", 
  "stories", "saledate", "price", "gba", "kitchens", "fireplaces", "landarea", 
  "latitude", "longitude", "quadrant")


match_index <- match(included, names(dtrain_full))
train <- dtrain_full[,match_index]

null_model <- lm(log(price) ~ 1, data=train)  # medv is the dependent variable; adjust accordingly
full_model <- lm(log(price) ~ (.)^2, data=train)

forward_selection_model <- step(null_model, 
                                scope=list(lower=null_model, upper=full_model), 
                                direction="forward")
```

```{r, eval=T, results='hide'}
summary(forward_selection_model)
```


```{r, results='hide'}
m3 <- gam(((price^lambda-1)/lambda) ~ s(rooms)
                +s(total_bath)+s(rmdl_diff)
                +s(bedrm)+s(ayb, k = 20)+s(eyb)+s(saledate)+s(gba)
                +fireplaces+s(stories)
                +s(landarea)+s(latitude)+s(longitude)
                + heat+ac+style+grade+cndtn+roof+intwall+kitchens+nbhd+ward
                +quadrant+if_rmdl+buy_first
                + ti(eyb, ayb) + ti(gba,bathrm)+ti(gba,landarea)+ti(longitude,gba)
                +ti(gba,latitude)
                ,data = dtrain_full)

# Summary of the model
summary(m3)
```


```{r, results='hide'}
m4 <- gam(((price^lambda-1)/lambda) ~ s(rooms)
                +s(total_bath)+s(rmdl_diff)
                +s(bedrm)+s(ayb, k = 20, by = cndtn)+s(eyb)+s(saledate)+s(gba)
                +fireplaces+s(stories)
                +s(landarea)+s(latitude)+s(longitude)
                + heat+ac+style+grade+cndtn+roof+intwall+kitchens+nbhd+ward
                +quadrant+if_rmdl+buy_first
                + ti(eyb, ayb) + ti(gba,landarea)+ti(longitude,gba)
                +ti(saledate,latitude)
                #+ ti(longitude, ayb)
                #+ti(longitude, eyb)
                ,data = dtrain_full)

summary(m4)
```

```{r}
AIC(m3, m4)
```


```{r}
# combine style
dtrain_full$style_com <- as.character(dtrain_full$style) 

for (i in seq(nrow(dtrain_full))) {
  if (dtrain_full$style_com[i] == "1.5 Story Fin" |
      dtrain_full$style_com[i] == "1.5 Story Unfin") {
    dtrain_full$style_com[i] <- "1.5 Story"
  } else if (dtrain_full$style_com[i] == "2.5 Story Fin" |
             dtrain_full$style_com[i] == "2.5 Story Unfin"){
    dtrain_full$style_com[i] <- "2.5 Story"
  }
}
dtrain_full$style_com <- as.factor(dtrain_full$style_com) 
```


```{r, results='hide'}  
m5 <- gam(((price^lambda-1)/lambda) ~ s(rooms)
             +s(total_bath)+s(rmdl_diff)
             +s(bedrm)+s(ayb, k = 20, by = cndtn)+s(eyb)+s(saledate)+s(gba)
             +fireplaces
             +s(landarea)+s(latitude)+s(longitude)
             + heat+ac+grade+cndtn+roof+kitchens+nbhd+ward
             +quadrant+if_rmdl+style_com+intwall+buy_first
             + ti(eyb, ayb) + ti(gba,landarea)+ti(longitude,gba)
             + ti(longitude, ayb)+ti(saledate,latitude)
             ,data = dtrain_full)
```


```{r}
AIC(m3, m4, m5)
```



```{r, results='hide'}
m6 <- gam(((price^lambda-1)/lambda) ~ s(rooms)
             +s(total_bath)+s(rmdl_diff)
             +s(bedrm)+s(ayb, k = 20, by = cndtn)+s(eyb)+s(saledate)+s(gba)
             +fireplaces
             +s(landarea)+s(latitude)+s(longitude)
             + heat+ac+style+grade+cndtn+roof+intwall+kitchens+nbhd+ward
             +quadrant+if_rmdl+buy_first
             + ti(eyb, ayb) + ti(gba,landarea)+ti(longitude,gba)
             + ti(longitude, ayb)
             +ti(longitude, eyb)+ti(saledate,latitude)
             ,data = dtrain_full)
```



```{r}
AIC(m6)
```

## 2.3 final model

```{r}
final <- gam(((price^lambda-1)/lambda) ~ s(rooms)
             +s(total_bath)+s(rmdl_diff)
             +s(bedrm)+s(ayb, k = 20, by = cndtn)+s(eyb)+s(saledate)+s(gba)
             +fireplaces
             +s(landarea)+s(latitude)+s(longitude)
             + heat+ac+style+grade+cndtn+roof+intwall+kitchens+nbhd+ward
             +quadrant+if_rmdl+buy_first
             + ti(eyb, ayb) + ti(gba,landarea)+ti(longitude,gba)
             + ti(longitude, ayb)
             +ti(longitude, eyb)+ti(saledate,latitude)
             ,data = dtrain_full)
```






